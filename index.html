<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RBI FIELD | SEC JERICK</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="application-name" content="RBI FIELD">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* --- MODERN DESIGN VARIABLES --- */
        :root {
            --primary: #0f172a;       /* Slate 900 */
            --accent: #3b82f6;        /* Blue 500 */
            --accent-hover: #2563eb;  /* Blue 600 */
            --bg: #f1f5f9;            /* Slate 100 */
            --card: #ffffff;
            --text-main: #334155;     /* Slate 700 */
            --text-light: #64748b;    /* Slate 500 */
            --danger: #ef4444;        /* Red 500 */
            --success: #22c55e;       /* Green 500 */
            --warning: #f59e0b;       /* Amber 500 */
            --male: #3b82f6;
            --female: #ec4899;
        }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow-x: hidden; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); -webkit-tap-highlight-color: transparent; }

        /* --- UI COMPONENTS --- */
        .context-bar {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 900;
            height: 70px; /* Fixed height to ensure tabs fit perfectly below */
        }
        
        .purok-selector-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .purok-selector-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }
        .purok-badge { background: var(--warning); color: #000; padding: 2px 6px; border-radius: 10px; font-weight: 800; font-size: 11px; }

        .app-container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding-bottom: 20px; 
            min-height: 100vh; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
        }

        /* TAB NAV - UPDATED FIT */
        .tab-nav { 
            display: flex; 
            background: white; 
            border-bottom: 1px solid #e2e8f0; 
            position: sticky; 
            top: 70px; /* MATCH CONTEXT BAR HEIGHT */
            z-index: 800; 
            overflow-x: auto; 
            white-space: nowrap;
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            padding-right: 20px; /* Add spacing at the end */
        }
        .tab-nav::-webkit-scrollbar { display: none; }

        .tab-btn {
            flex: 1 0 auto; 
            border: none; background: none; 
            padding: 16px 15px; 
            font-size: 11px; font-weight: 700; color: var(--text-light);
            cursor: pointer; border-bottom: 3px solid transparent; 
            transition: 0.2s; white-space: nowrap;
            text-align: center;
            min-width: 70px; 
            letter-spacing: 0.5px;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* CONTENT AREAS */
        .content-area { padding: 20px; display: none; opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; flex: 1; }
        .content-area.active { display: block; opacity: 1; }
        
        .slide-in-right { animation: slideInRight 0.3s forwards; }
        .slide-in-left { animation: slideInLeft 0.3s forwards; }
        
        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .card-section {
            background: var(--card); padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); margin-bottom: 20px;
            border: 1px solid #f1f5f9;
        }
        .section-title {
            color: var(--primary); font-size: 13px; font-weight: 800;
            border-left: 4px solid var(--accent); padding-left: 12px; margin: 0 0 20px 0;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .form-group { margin-bottom: 18px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.8px; }
        .req { color: var(--danger); margin-left: 2px; }

        input, select {
            width: 100%; padding: 14px 16px;
            border-radius: 10px; border: 1px solid #e2e8f0;
            font-size: 14px; background: #f8fafc; color: #1e293b;
            transition: all 0.2s; text-transform: uppercase;
            font-weight: 500;
        }
        input:focus, select:focus { border-color: var(--accent); background: white; outline: none; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

        /* CUSTOM SELECT ARROW FIX */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 40px; /* Space for the arrow */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233b82f6%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 10px;
        }

        .btn {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            font-size: 13px; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 10px 20px -10px rgba(59, 130, 246, 0.5); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 10px 20px -10px rgba(34, 197, 94, 0.5); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: #e2e8f0; color: var(--text-main); }
        .btn-small { width: auto; padding: 8px 16px; font-size: 11px; }

        .sector-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .toggle-card {
            background: #fff; border: 1px solid #e2e8f0; padding: 15px;
            border-radius: 10px; display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s;
        }
        .toggle-card:hover { border-color: var(--accent); }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); margin: 0; }

        /* TOASTS */
        #toast-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 100000; 
            display: flex; flex-direction: column; gap: 10px; align-items: center;
            width: 90%; max-width: 400px;
        }
        .toast {
            background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px;
            font-size: 13px; font-weight: 500;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.3);
            animation: slideUpFade 0.3s ease-out; display: flex; align-items: center; gap: 12px; width: 100%;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--accent); }
        @keyframes slideUpFade { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 85%; max-width: 350px;
            border-radius: 24px; padding: 30px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* LOADING SPINNER */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); width: 40px; height: 40px;
            border-radius: 50%; border-left-color: var(--accent);
            animation: spin 1s linear infinite; margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* FOOTER BRANDING */
        .app-footer {
            text-align: center;
            padding: 30px 20px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-light);
            letter-spacing: 1.5px;
            margin-top: auto;
            text-transform: uppercase;
            opacity: 0.6;
        }

        /* STATIC EXPORT BUTTON CONTAINER */
        .static-export-bar {
            position: sticky;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            z-index: 500;
            margin: 0 -20px -20px -20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        /* LISTS */
        .record-card {
            background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px;
            border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .record-card:active { transform: scale(0.98); background: #f8fafc; }
        .record-card h5 { margin: 0; font-size: 14px; color: var(--primary); font-weight: 700; }
        .record-card p { margin: 3px 0 0; font-size: 11px; color: var(--text-light); font-weight: 500; }
        
        .pred-list {
            list-style: none; padding: 0; margin: 0; border: 1px solid #cbd5e1; border-top: none;
            max-height: 150px; overflow-y: auto; background: white; border-radius: 0 0 10px 10px; display: none;
            text-align: left;
        }
        .pred-item { padding: 12px 15px; font-size: 13px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .pred-item:active { background: #f1f5f9; }

        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 25px; }
        .page-btn { padding: 8px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-main); }
        .page-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        
        .config-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 500; }
        
        /* PWA INSTALL BUTTON */
        .install-float-btn {
            position: fixed; bottom: 30px; right: 25px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; padding: 14px 24px; border-radius: 50px;
            box-shadow: 0 15px 30px -8px rgba(37, 99, 235, 0.5);
            display: none; z-index: 10000; font-weight: 800; font-size: 13px;
            align-items: center; gap: 10px; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 0.5px;
        }
        @keyframes bounceIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* SHARE LINK STYLING */
        .share-link {
            color: var(--accent);
            text-decoration: underline;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            padding: 10px;
        }
        .template-btn {
            padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px;
            margin-bottom: 10px; cursor: pointer; text-align: left;
            display: flex; align-items: center; gap: 10px; background: #f8fafc;
        }
        .template-btn:hover { border-color: var(--accent); background: white; }
    </style>
</head>
<body>

<button id="install-btn" class="install-float-btn">
    <i class="fas fa-download"></i> INSTALL APP
</button>

<div id="toast-container"></div>

<div id="login-overlay" class="modal-overlay" style="display:flex; z-index:99990;">
    <div class="modal-box">
        <div style="color:var(--primary); font-size:48px; margin-bottom:15px;"><i class="fas fa-shield-alt"></i></div>
        <h3 style="margin:0; color:var(--primary); font-weight:800; letter-spacing:1px;">SECURITY CHECK</h3>
        <p style="font-size:12px; color:#64748b; margin-bottom:25px; line-height:1.5;" id="login-msg">Enter System Password to Access</p>
        <input type="password" id="login-pass" style="text-align:center; margin-bottom:20px; font-size:16px; letter-spacing:2px;" placeholder="• • • •">
        <button class="btn btn-primary" onclick="attemptLogin()">UNLOCK SYSTEM</button>
        <div style="margin-top:20px; font-size:11px; cursor:pointer; color:var(--accent); font-weight:600;" onclick="forgotPassword()">Reset Password</div>
    </div>
</div>

<div id="loading-modal" class="modal-overlay" style="z-index:99998;">
    <div class="modal-box">
        <div class="spinner"></div>
        <h3 id="loading-title" style="margin:0; color:var(--primary);">PROCESSING...</h3>
        <p id="loading-desc" style="font-size:13px; color:#666; margin: 10px 0 0 0;">Please wait.</p>
    </div>
</div>

<div id="export-options-modal" class="modal-overlay" style="z-index:99995;">
    <div class="modal-box">
        <h3 style="margin:0 0 15px 0;">CHOOSE TEMPLATE</h3>
        <p style="font-size:12px; color:#666; margin-bottom:20px;">Select the export format:</p>
        
        <div class="template-btn" onclick="processExport('BIMS')">
            <i class="fas fa-file-invoice" style="color:var(--warning);"></i>
            <div>
                <div style="font-weight:700; font-size:13px;">BIMS COMPATIBLE</div>
                <div style="font-size:10px; color:#64748b;">Gov't Format (Sheet 1 Instr., Sheet 2 Data). <span style="color:var(--danger);">Note: Drops extra fields.</span></div>
            </div>
        </div>

        <div class="template-btn" onclick="processExport('RBIS')">
            <i class="fas fa-database" style="color:var(--accent);"></i>
            <div>
                <div style="font-weight:700; font-size:13px;">RBIS FULL DATA</div>
                <div style="font-size:10px; color:#64748b;">Exports all system columns including Purok & Sectors.</div>
            </div>
        </div>

        <div class="template-btn" onclick="processExport('BOTH')">
            <i class="fas fa-copy" style="color:var(--success);"></i>
            <div>
                <div style="font-weight:700; font-size:13px;">DOWNLOAD BOTH</div>
                <div style="font-size:10px; color:#64748b;">Get both BIMS and RBIS files.</div>
            </div>
        </div>

        <button class="btn btn-ghost" onclick="closeExportModal()" style="margin-top:10px;">CANCEL</button>
    </div>
</div>

<div id="share-modal" class="modal-overlay" style="z-index:99996;">
    <div class="modal-box">
        <div style="color:var(--success); font-size:50px; margin-bottom:15px;"><i class="fas fa-check-circle"></i></div>
        <h3 style="margin:0;">DOWNLOAD COMPLETE</h3>
        <p style="font-size:13px; color:#666; margin: 10px 0 25px 0;">File has been saved to your device.</p>
        
        <a id="share-link-text" class="share-link" onclick="triggerShareAction()">
            <i class="fas fa-share-alt"></i> Share File
        </a>

        <div style="display:flex; gap:10px; margin-top:25px;">
            <button class="btn btn-ghost" onclick="closeShareModal()">CLOSE</button>
        </div>
    </div>
</div>

<div id="custom-prompt-modal" class="modal-overlay" style="z-index:99999;">
    <div class="modal-box">
        <h3 id="prompt-title" style="margin:0; color:var(--primary);">INPUT</h3>
        <p id="prompt-msg" style="font-size:13px; color:#666; margin: 10px 0 20px 0;"></p>
        <input id="prompt-input" type="text" style="text-align:center; margin-bottom:20px; font-size:16px;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-ghost" onclick="closePromptModal()">CANCEL</button>
            <button class="btn btn-primary" onclick="submitPromptModal()">CONFIRM</button>
        </div>
    </div>
</div>

<div id="custom-confirm-modal" class="modal-overlay" style="z-index:99997;">
    <div class="modal-box">
        <div style="color:var(--warning); font-size:40px; margin-bottom:10px;"><i class="fas fa-exclamation-triangle"></i></div>
        <h3 id="confirm-title" style="margin:0;">CONFIRM ACTION</h3>
        <p id="confirm-msg" style="font-size:13px; color:#666; margin: 10px 0 25px 0;"></p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-ghost" onclick="closeConfirmModal()">CANCEL</button>
            <button class="btn btn-primary" onclick="executeConfirmAction()">CONFIRM</button>
        </div>
    </div>
</div>

<div id="hh-modal" class="modal-overlay">
    <div class="modal-box" style="width: 95%; max-width: 450px;">
        <h4 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:15px; font-weight:800;">HOUSEHOLD MANAGER</h4>
        
        <div class="form-group" style="text-align:left;">
            <label>Household Number / ID</label>
            <input id="hh-id-input" placeholder="e.g., 2024-001">
        </div>

        <div style="text-align:left; margin-bottom:20px;">
            <label>Add Members (Search)</label>
            <input id="hh-member-search" oninput="searchMemberForHH()" placeholder="Type Name...">
            <ul id="hh-pred-list" class="pred-list"></ul>
        </div>

        <div style="text-align:left;">
            <label>Current Members & Roles:</label>
            <div id="hh-members-display" style="border:1px solid #e2e8f0; padding:15px; border-radius:12px; max-height:200px; overflow-y:auto; background:#f8fafc; min-height: 100px;">
                <small style="color:#94a3b8; font-style:italic;">No members added yet.</small>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:25px;">
            <button class="btn btn-ghost" onclick="closeHHModal()">CLOSE</button>
            <button class="btn btn-success" onclick="saveHousehold()">SAVE HOUSEHOLD</button>
        </div>
    </div>
</div>

<div class="app-container">

    <div class="context-bar">
        <div class="context-info">
            <h4 style="margin:0; font-weight:900; letter-spacing:1px; font-size:16px;">RBI FIELD</h4>
        </div>
        <div class="purok-selector-btn" onclick="openPurokInputModal()">
            <span>PUROK</span>
            <span class="purok-badge" id="globalPurokDisplay">1</span>
            <i class="fas fa-chevron-down" style="font-size:10px;"></i>
        </div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('reg')" id="btn-reg"><i class="fas fa-user-plus"></i> FORM</button>
        <button class="tab-btn" onclick="switchTab('rec')" id="btn-rec"><i class="fas fa-list"></i> RECORDS</button>
        <button class="tab-btn" onclick="switchTab('hh')" id="btn-hh"><i class="fas fa-home"></i> HOUSEHOLDS</button>
        <button class="tab-btn" onclick="switchTab('conf')" id="btn-conf"><i class="fas fa-cog"></i> SET</button>
    </div>

    <div id="tab-registration" class="content-area active">
        <div id="edit-banner" style="background:var(--warning); color:white; padding:12px; border-radius:8px; margin-bottom:20px; display:none; text-align:center; font-size:12px; font-weight:800; letter-spacing:0.5px; box-shadow:0 4px 10px rgba(245, 158, 11, 0.3);">
            <i class="fas fa-edit"></i> EDITING RECORD - PUROK <span id="edit-purok-indicator"></span>
        </div>

        <div class="card-section">
            <h5 class="section-title">1. PERSONAL DATA</h5>
            <div class="form-group">
                <label>Inhabitant Type<span class="req">*</span></label>
                <select id="inhabitantType"><option>NON-MIGRANT</option><option>MIGRANT</option><option>TRANSIENT</option></select>
            </div>
            <div class="form-group"><label>Last Name<span class="req">*</span></label><input id="lastName" placeholder="DELA CRUZ"></div>
            <div class="form-group"><label>First Name<span class="req">*</span></label><input id="firstName" placeholder="JUAN"></div>
            <div class="form-group"><label>Middle Name</label><input id="middleName" placeholder="(OPTIONAL)"></div>
            <div class="form-group"><label>Suffix</label><input id="suffix" placeholder="JR, III (OPTIONAL)"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="form-group"><label>Birthday<span class="req">*</span></label><input type="date" id="birthDate"></div>
                <div class="form-group"><label>Sex<span class="req">*</span></label><select id="sex"><option>MALE</option><option>FEMALE</option></select></div>
            </div>
            <div class="form-group"><label>Birth Place<span class="req">*</span></label><input id="birthPlace"></div>
            <div class="form-group"><label>Civil Status<span class="req">*</span></label>
                <select id="civilStatus"><option>SINGLE</option><option>MARRIED</option><option>WIDOWED</option><option>SEPARATED</option><option>COMMON LAW/ LIVE-IN</option></select>
            </div>
            <div class="form-group"><label>Citizenship<span class="req">*</span></label><input id="citizenship" value="FILIPINO"></div>
            <div class="form-group">
                <label>Religion (Select/Type Other)<span class="req">*</span></label>
                <select id="religionSelect" onchange="checkReligion()">
                    <option value="ROMAN CATHOLIC">ROMAN CATHOLIC</option>
                    <option value="IGLESIA NI CRISTO">IGLESIA NI CRISTO</option>
                    <option value="ISLAM">ISLAM</option>
                    <option value="EVANGELICALS">EVANGELICALS</option>
                    <option value="BAPTIST">BAPTIST</option>
                    <option value="SEVENTH DAY ADVENTIST">SEVENTH DAY ADVENTIST</option>
                    <option value="AGLIPAYAN">AGLIPAYAN</option>
                    <option value="JEHOVAH'S WITNESS">JEHOVAH'S WITNESS</option>
                    <option value="OTHERS">OTHERS (PLEASE SPECIFY)</option>
                </select>
                <input id="religionOther" placeholder="TYPE RELIGION HERE..." style="display:none; margin-top:10px; border-color:var(--accent);">
            </div>
            <div class="form-group"><label>Profession / Occupation</label><input id="profession"></div>
        </div>

        <div class="card-section">
            <h5 class="section-title">2. ADDRESS & EDUCATION</h5>
            <div class="form-group">
                <label>Additional Address / Landmark<span class="req">*</span></label>
                <select id="addressSelect"><option value="">SELECT ADDRESS...</option></select>
                <small style="color:var(--accent); cursor:pointer; font-weight:600; margin-top:5px; display:inline-block;" onclick="switchTab('conf')"> + Manage Addresses in Set</small>
            </div>
            <div class="form-group"><label>Educational Attainment</label>
                <select id="education">
                    <option>NONE</option><option>ELEMENTARY LEVEL</option><option>ELEMENTARY GRADUATE</option>
                    <option>HIGH SCHOOL LEVEL</option><option>HIGH SCHOOL GRADUATE</option><option>SENIOR HIGH SCHOOL LEVEL</option>
                    <option>SENIOR HIGH SCHOOL GRADUATE</option><option>COLLEGE LEVEL</option><option>COLLEGE GRADUATE</option>
                    <option>VOCATIONAL</option><option>POST GRADUATE</option>
                </select>
            </div>
            <div class="form-group"><label>Contact Number</label><input id="contact" type="tel"></div>
        </div>

        <div class="card-section">
            <h5 class="section-title">3. SECTORAL MEMBERSHIP</h5>
            <div class="sector-grid">
                <div class="toggle-card"><label for="isOSY">OSY</label><input type="checkbox" id="isOSY"></div>
                <div class="toggle-card"><label for="isPWD">PWD</label><input type="checkbox" id="isPWD"></div>
                <div class="toggle-card"><label for="is4Ps">4Ps</label><input type="checkbox" id="is4Ps"></div>
                <div class="toggle-card"><label for="isIPS">IPs</label><input type="checkbox" id="isIPS"></div>
                <div class="toggle-card"><label for="isSolo">Solo Parent</label><input type="checkbox" id="isSolo"></div>
            </div>
        </div>

        <div class="card-section" style="background:#f8fafc; border:1px dashed #cbd5e1;">
            <h5 class="section-title" style="border-left-color:var(--text-light); color:var(--text-main);">4. MOTHER'S MAIDEN NAME</h5>
            <div class="form-group">
               <input id="motherSearch" list="motherList" onchange="autoFillMother(this)" placeholder="SEARCH EXISTING MOTHERS..." style="border-color:var(--accent);">
               <datalist id="motherList"></datalist>
            </div>
            <div class="form-group"><input id="mFirst" placeholder="MOTHER'S FIRST NAME"></div>
            <div class="form-group"><input id="mMiddle" placeholder="MOTHER'S MIDDLE NAME"></div>
            <div class="form-group"><input id="mLast" placeholder="MOTHER'S LAST NAME"></div>
        </div>

        <div style="display:flex; gap:15px; margin-top:30px;">
            <button id="btn-cancel" class="btn btn-danger" onclick="cancelEdit()" style="display:none;">CANCEL EDIT</button>
            <button id="btn-save" class="btn btn-primary" onclick="saveRecord()"><i class="fas fa-save"></i> SAVE RECORD</button>
        </div>
    </div>

    <div id="tab-records" class="content-area">
        <div class="form-group">
            <input id="searchBox" oninput="renderList()" placeholder="SEARCH BY NAME..." style="box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        </div>
        <div id="resultList" style="margin-top:15px; margin-bottom: 20px;"></div>
        
        <div class="pagination">
            <button id="btn-prev-rec" class="page-btn" onclick="changeRecPage(-1)">Prev</button>
            <span id="rec-page-indicator" style="align-self:center; font-size:12px; font-weight:600; color:var(--text-light);">Page 1</span>
            <button id="btn-next-rec" class="page-btn" onclick="changeRecPage(1)">Next</button>
        </div>

        <div class="static-export-bar">
            <button class="btn btn-success" onclick="openExportModal()"><i class="fas fa-file-excel"></i> EXPORT TO EXCEL</button>
        </div>
    </div>

    <div id="tab-households" class="content-area">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input id="searchHH" oninput="renderHouseholdList()" placeholder="Search Household or Member..." style="flex:1;">
            <button class="btn btn-primary" style="width:auto;" onclick="openHHModal()"><i class="fas fa-plus"></i></button>
        </div>
        <div id="hh-list-container"></div>
        <div class="pagination">
            <button id="btn-prev-hh" class="page-btn" onclick="changeHHPage(-1)">Prev</button>
            <span id="hh-page-indicator" style="align-self:center; font-size:12px; font-weight:600; color:var(--text-light);">Page 1</span>
            <button id="btn-next-hh" class="page-btn" onclick="changeHHPage(1)">Next</button>
        </div>
    </div>

    <div id="tab-config" class="content-area">
        <div class="card-section">
            <h5 class="section-title">SYSTEM CONFIGURATION</h5>
            <div class="form-group">
                <label>Set Maximum Purok Number</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="confPurok" placeholder="Default: 10">
                    <button class="btn btn-primary" style="width:auto;" onclick="savePurokConf()">UPDATE</button>
                </div>
            </div>
            <div class="form-group" style="margin-top:25px;">
                <label>Manage Additional Addresses</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input id="newAddress" placeholder="e.g. UPPER BASAK">
                    <button class="btn btn-small btn-success" onclick="addAddress()">ADD</button>
                </div>
                <div class="list" id="listAddresses" style="max-height:200px; overflow-y:auto; border:1px solid #f1f5f9; border-radius:10px;"></div>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:30px 0;">
            <div class="form-group">
                 <label>Admin Password Management</label>
                 <button class="btn btn-ghost" onclick="forgotPassword()">Reset Admin Password</button>
            </div>
        </div>
    </div>

    <div class="app-footer">SEC JERICK™</div>

</div>

<input type="hidden" id="tempPurokTarget">

<div id="viewer-overlay" class="modal-overlay" onclick="if(event.target===this) closeViewer()">
    <div class="viewer-card" style="background:white; width:100%; max-width:500px; height:90vh; border-radius:20px 20px 0 0; position:absolute; bottom:0; padding:30px; overflow-y:auto; animation: slideUp 0.3s;">
        <h3 style="color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:15px; margin-bottom:25px; font-weight:800;">RECORD DETAILS</h3>
        <div id="viewer-content"></div>
        <div id="viewer-actions" style="margin-top:30px; display:flex; flex-direction:column; gap:12px;"></div>
    </div>
</div>

<style> @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } } </style>

<script>
// --- PWA INSTALLATION ---
let deferredPrompt;
const installBtn = document.getElementById('install-btn');

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
        reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    showToast("New Update Available! Please refresh.", "success");
                }
            });
        });
    }).catch(err => console.log('SW Fail', err));
}

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'flex';
});

installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        deferredPrompt = null;
        installBtn.style.display = 'none';
    }
});

window.addEventListener('appinstalled', () => {
    installBtn.style.display = 'none';
    showToast("App Installed Successfully!", "success");
});

// --- CONFIGURATION ---
const HEADERS_RBIS = [
    "INHABITANT TYPE", "LAST NAME", "FIRST NAME", "MIDDLE NAME", "SUFFIX", 
    "BIRTH PLACE", "BIRTHDATE (YYYY-MM-DD)", "SEX", "CIVIL STATUS", "CITIZENSHIP", 
    "PROFESSION/ OCCUPATION", "CONTACT NUMBER", "EMAIL ADDRESS", 
    "HIGHEST EDUCATIONAL ATTAINMENT", "MOTHER'S FIRST NAME", 
    "MOTHER'S MIDDLE NAME", "MOTHER'S LAST NAME",
    "PUROK", "ADDITIONAL ADDRESS", "RELIGION", 
    "IS OSY", "IS PWD", "IS 4Ps", "IS IPS", "IS SOLO PARENT"
];

// BIMS Headers (from Sheet 2 Data snippet)
const HEADERS_BIMS = [
    "INHABITANT TYPE","LAST NAME","FIRST NAME","MIDDLE NAME","SUFFIX","BIRTH PLACE","BIRTHDATE (YYYY-MM-DD)","SEX","CIVIL STATUS","CITIZENSHIP","PROFESSION/ OCCUPATION","CONTACT NUMBER","EMAIL ADDRESS","HIGHEST EDUCATIONAL ATTAINMENT","MOTHER'S FIRST NAME","MOTHER'S MIDDLE NAME","MOTHER'S LAST NAME"
];

let records = JSON.parse(localStorage.getItem('rbiRecords')) || [];
let households = JSON.parse(localStorage.getItem('rbiHouseholds')) || [];
let settings = JSON.parse(localStorage.getItem('rbi_settings')) || { 
    custom_password: '', purok_max: 10, addresses: []
};

let currentGlobalPurok = localStorage.getItem('globalPurok') || "1";
let editingIndex = -1; 
let hhPage = 1;
let recPage = 1;
let currentEditingHH = null; 
let tempHHMembers = []; 
let promptCallback = null;
let confirmCallback = null;
let currentExportFile = null;

const TABS = ['reg', 'rec', 'hh', 'conf'];
let currentTab = 'reg';

// --- TOUCH LOGIC ---
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
document.addEventListener('touchend', e => { 
    touchEndX = e.changedTouches[0].screenX;
    const threshold = 50; 
    if (touchEndX < touchStartX - threshold) changeTabByOrder(1);
    if (touchEndX > touchStartX + threshold) changeTabByOrder(-1);
});

function changeTabByOrder(dir) {
    const currentIndex = TABS.indexOf(currentTab);
    let nextIndex = currentIndex + dir;
    if(nextIndex < 0) nextIndex = 0;
    if(nextIndex >= TABS.length) nextIndex = TABS.length - 1;
    if(nextIndex !== currentIndex) switchTab(TABS[nextIndex], dir);
}

// --- UTILS ---
function showToast(msg, type = 'info') {
    const box = document.createElement('div');
    box.className = `toast ${type}`;
    let icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : (type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>');
    box.innerHTML = `${icon} <span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(box);
    setTimeout(() => { box.style.opacity = '0'; setTimeout(() => box.remove(), 300); }, 3000);
}

function showLoading(show, title="PROCESSING...", desc="Please wait.") {
    document.getElementById('loading-title').innerText = title;
    document.getElementById('loading-desc').innerText = desc;
    document.getElementById('loading-modal').style.display = show ? 'flex' : 'none';
}

function showCustomPrompt(title, msg, callback) {
    document.getElementById('prompt-title').innerText = title;
    document.getElementById('prompt-msg').innerText = msg;
    document.getElementById('prompt-input').value = '';
    document.getElementById('custom-prompt-modal').style.display = 'flex';
    document.getElementById('prompt-input').focus();
    promptCallback = callback;
}
function submitPromptModal() {
    const val = document.getElementById('prompt-input').value;
    document.getElementById('custom-prompt-modal').style.display = 'none';
    if(promptCallback) promptCallback(val);
}
function closePromptModal() { document.getElementById('custom-prompt-modal').style.display = 'none'; }

function showCustomConfirm(title, msg, callback) {
    document.getElementById('confirm-title').innerText = title;
    document.getElementById('confirm-msg').innerText = msg;
    document.getElementById('custom-confirm-modal').style.display = 'flex';
    confirmCallback = callback;
}
function executeConfirmAction() {
    document.getElementById('custom-confirm-modal').style.display = 'none';
    if(confirmCallback) confirmCallback();
}
function closeConfirmModal() { document.getElementById('custom-confirm-modal').style.display = 'none'; }

// --- AUTH (IMPROVED) ---
function getDynamicPassword() {
    const now = new Date();
    const y = now.getFullYear();
    const onejan = new Date(y, 0, 1);
    const w = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
    return `RBI-${now.getMonth()}${now.getDate()}${y}${w*2}`;
}

window.onload = function() {
    if(!settings.custom_password) document.getElementById('login-msg').innerText = "Create Your Password to Start";
    updateMotherDatalist(); loadConfigUI(); updateGlobalPurokUI();
}

function attemptLogin() {
    const input = document.getElementById('login-pass').value.trim(); // Added trim
    const dynamicMaster = getDynamicPassword();

    // IF NO PASSWORD IS SET YET
    if (!settings.custom_password) {
        if(input.length > 0) {
            settings.custom_password = input;
            saveSettings(); showToast("Password Set! Logged in.", "success");
            document.getElementById('login-overlay').style.display = 'none';
        } else showToast("Create a password.", "error");
        return;
    }

    // CHECK SAVED PASSWORD OR DYNAMIC MASTER CODE
    if (input === settings.custom_password || input.toUpperCase() === dynamicMaster) {
        document.getElementById('login-overlay').style.display = 'none';
    } else {
        showToast("Incorrect Password.", "error");
    }
}

function forgotPassword() {
    showCustomPrompt("ADMIN RECOVERY", "Enter Dynamic Admin Code:", (code) => {
        const dynamicMaster = getDynamicPassword();
        
        // Robust check: ignores spaces and case sensitivity
        if(code && code.trim().toUpperCase() === dynamicMaster) {
            setTimeout(() => {
                showCustomPrompt("RESET PASSWORD", "Enter New Password:", (newPass) => {
                    if(newPass && newPass.trim().length > 0) {
                        settings.custom_password = newPass.trim();
                        saveSettings(); showToast("Password Reset Successfully.", "success");
                    }
                });
            }, 500);
        } else if(code) {
            showToast("Invalid Code.", "error");
        }
    });
}

function saveSettings() { localStorage.setItem('rbi_settings', JSON.stringify(settings)); }

// --- UI LOGIC ---
function updateGlobalPurokUI() {
    document.getElementById('globalPurokDisplay').innerText = currentGlobalPurok;
    localStorage.setItem('globalPurok', currentGlobalPurok);
}

function openPurokInputModal() {
    const max = settings.purok_max || 10;
    showCustomPrompt("SET ACTIVE PUROK", `Enter Purok Number (1-${max}):`, (input) => {
        if(input && parseInt(input) >= 1 && parseInt(input) <= max && input !== currentGlobalPurok) {
            showCustomConfirm("CHANGE PUROK?", `This affects NEW entries.\nCurrent: ${currentGlobalPurok} -> New: ${input}`, () => {
                currentGlobalPurok = input;
                updateGlobalPurokUI();
                showToast("Active Purok Updated", "success");
            });
        }
    });
}

function loadConfigUI() {
    const pMax = settings.purok_max || 10;
    document.getElementById('confPurok').value = pMax;
    const sel = document.getElementById('addressSelect');
    sel.innerHTML = '<option value="">SELECT ADDRESS...</option>';
    (settings.addresses || []).forEach(addr => {
        let opt = document.createElement('option'); opt.value = addr; opt.innerText = addr; sel.appendChild(opt);
    });
    const list = document.getElementById('listAddresses');
    list.innerHTML = '';
    (settings.addresses || []).forEach((addr, i) => {
        list.innerHTML += `<div class="config-item"><span>${addr}</span> <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="removeAddress(${i})"></i></div>`;
    });
}
function savePurokConf() {
    const val = parseInt(document.getElementById('confPurok').value);
    if(val > 0) { settings.purok_max = val; saveSettings(); showToast("Purok Limit Updated", "success"); }
}
function addAddress() {
    const val = document.getElementById('newAddress').value.toUpperCase().trim();
    if(val) {
        if(!settings.addresses) settings.addresses = [];
        settings.addresses.push(val);
        saveSettings(); document.getElementById('newAddress').value = ""; loadConfigUI();
    }
}
function removeAddress(i) {
    showCustomConfirm("DELETE ADDRESS", "Remove this address from list?", () => {
        settings.addresses.splice(i, 1); saveSettings(); loadConfigUI();
    });
}

function switchTab(tab, dir = 0) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    const contents = document.querySelectorAll('.content-area');
    contents.forEach(c => {
        c.classList.remove('active', 'slide-in-left', 'slide-in-right');
    });

    const activeContent = document.getElementById(`tab-${tab === 'reg' ? 'registration' : (tab === 'rec' ? 'records' : (tab === 'hh' ? 'households' : 'config'))}`);
    activeContent.classList.add('active');
    if(dir > 0) activeContent.classList.add('slide-in-right');
    else if(dir < 0) activeContent.classList.add('slide-in-left');

    document.getElementById(`btn-${tab}`).classList.add('active');
    if(tab === 'rec') renderList();
    if(tab === 'hh') renderHouseholdList();
}

function checkReligion() {
    const sel = document.getElementById('religionSelect');
    document.getElementById('religionOther').style.display = (sel.value === 'OTHERS') ? 'block' : 'none';
}

function saveRecord(){
  const idsToCheck = ['lastName', 'firstName', 'birthPlace', 'birthDate', 'citizenship', 'addressSelect'];
  for(let id of idsToCheck) {
      if(!document.getElementById(id).value.trim()) { showToast("FIELD REQUIRED: " + id.toUpperCase(), "error"); return; }
  }
  let finalReligion = document.getElementById('religionSelect').value;
  if(finalReligion === 'OTHERS') {
      finalReligion = document.getElementById('religionOther').value.toUpperCase();
      if(!finalReligion) { showToast("SPECIFY RELIGION", "error"); return; }
  }
  let purokToSave = currentGlobalPurok;
  if(editingIndex > -1) purokToSave = records[editingIndex][17]; 

  const newRow = [
    document.getElementById('inhabitantType').value, document.getElementById('lastName').value.toUpperCase(),
    document.getElementById('firstName').value.toUpperCase(), document.getElementById('middleName').value.toUpperCase(),
    document.getElementById('suffix').value.toUpperCase(), document.getElementById('birthPlace').value.toUpperCase(),
    document.getElementById('birthDate').value, document.getElementById('sex').value, document.getElementById('civilStatus').value,
    document.getElementById('citizenship').value.toUpperCase(), document.getElementById('profession').value.toUpperCase(), 
    document.getElementById('contact').value, "", document.getElementById('education').value,
    document.getElementById('mFirst').value.toUpperCase(), document.getElementById('mMiddle').value.toUpperCase(),
    document.getElementById('mLast').value.toUpperCase(), purokToSave, document.getElementById('addressSelect').value, 
    finalReligion, document.getElementById('isOSY').checked ? "YES" : "NO", document.getElementById('isPWD').checked ? "YES" : "NO",
    document.getElementById('is4Ps').checked ? "YES" : "NO", document.getElementById('isIPS').checked ? "YES" : "NO",
    document.getElementById('isSolo').checked ? "YES" : "NO"
  ];

  if (editingIndex > -1) {
      records[editingIndex] = newRow; showToast('Record Updated!', "success"); cancelEdit(); 
  } else {
      records.push(newRow); showToast('Saved to Purok ' + purokToSave, "success");
  }
  localStorage.setItem('rbiRecords', JSON.stringify(records)); updateMotherDatalist();

  if(editingIndex === -1) {
      const currType = document.getElementById('inhabitantType').value;
      const currRel = "ROMAN CATHOLIC"; 
      document.querySelectorAll('input').forEach(i => { if(i.type === 'checkbox') i.checked = false; else i.value = ''; });
      document.getElementById('inhabitantType').value = currType; document.getElementById('citizenship').value = "FILIPINO";
      document.getElementById('religionSelect').value = currRel; document.getElementById('addressSelect').value = "";
      checkReligion(); document.getElementById('lastName').focus();
  }
}

function startEdit(index) {
    const r = records[index];
    document.getElementById('inhabitantType').value = r[0]; document.getElementById('lastName').value = r[1];
    document.getElementById('firstName').value = r[2]; document.getElementById('middleName').value = r[3];
    document.getElementById('suffix').value = r[4]; document.getElementById('birthPlace').value = r[5];
    document.getElementById('birthDate').value = r[6]; document.getElementById('sex').value = r[7];
    document.getElementById('civilStatus').value = r[8]; document.getElementById('citizenship').value = r[9];
    document.getElementById('profession').value = r[10]; document.getElementById('contact').value = r[11];
    document.getElementById('education').value = r[13]; document.getElementById('mFirst').value = r[14];
    document.getElementById('mMiddle').value = r[15]; document.getElementById('mLast').value = r[16];
    document.getElementById('addressSelect').value = r[18];

    const relVal = r[19] || "ROMAN CATHOLIC";
    const relSelect = document.getElementById('religionSelect');
    let exists = false;
    for(let i=0; i<relSelect.options.length; i++) if(relSelect.options[i].value === relVal) exists = true;
    if(exists) { relSelect.value = relVal; document.getElementById('religionOther').style.display = 'none'; } 
    else { relSelect.value = 'OTHERS'; document.getElementById('religionOther').style.display = 'block'; document.getElementById('religionOther').value = relVal; }

    document.getElementById('isOSY').checked = (r[20] === "YES"); document.getElementById('isPWD').checked = (r[21] === "YES");
    document.getElementById('is4Ps').checked = (r[22] === "YES"); document.getElementById('isIPS').checked = (r[23] === "YES");
    document.getElementById('isSolo').checked = (r[24] === "YES");

    editingIndex = index;
    document.getElementById('btn-save').innerHTML = '<i class="fas fa-check"></i> UPDATE RECORD';
    document.getElementById('btn-cancel').style.display = "flex";
    document.getElementById('edit-banner').style.display = "block";
    document.getElementById('edit-purok-indicator').innerText = r[17];
    closeViewer(); switchTab('reg');
}

function cancelEdit() {
    editingIndex = -1;
    document.getElementById('btn-save').innerHTML = '<i class="fas fa-save"></i> SAVE RECORD';
    document.getElementById('btn-cancel').style.display = "none"; document.getElementById('edit-banner').style.display = "none";
    document.querySelectorAll('input').forEach(i => { if(i.type === 'checkbox') i.checked = false; else i.value = ''; });
    document.getElementById('addressSelect').value = ""; document.getElementById('citizenship').value = "FILIPINO";
    document.getElementById('religionSelect').value = "ROMAN CATHOLIC"; checkReligion();
}

function renderList(){
  const q = document.getElementById('searchBox').value.toLowerCase();
  const list = document.getElementById('resultList'); list.innerHTML = '';
  
  let filtered = records.map((r, i) => ({data: r, index: i})).filter(item => item.data[1].toLowerCase().includes(q) || item.data[2].toLowerCase().includes(q));

  const itemsPerPage = 7;
  const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
  if(recPage > totalPages) recPage = totalPages; if(recPage < 1) recPage = 1;

  document.getElementById('rec-page-indicator').innerText = `Page ${recPage} of ${totalPages}`;
  document.getElementById('btn-prev-rec').className = `page-btn ${recPage===1?'disabled':''}`;
  document.getElementById('btn-next-rec').className = `page-btn ${recPage===totalPages?'disabled':''}`;

  const pageItems = filtered.slice((recPage - 1) * itemsPerPage, (recPage - 1) * itemsPerPage + itemsPerPage);

  if(pageItems.length === 0) { list.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8; font-style:italic;">NO RECORDS FOUND</div>'; return; }
  
  pageItems.forEach((item) => {
    const r = item.data; 
    const div = document.createElement('div'); div.className = 'record-card';
    div.onclick = () => viewRecord(item.index); 
    
    let genderIcon = r[7] === 'MALE' ? '<i class="fas fa-mars" style="color:var(--male);"></i>' : '<i class="fas fa-venus" style="color:var(--female);"></i>';
    
    div.innerHTML = `
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="background:#f1f5f9; padding:10px; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center;">${genderIcon}</div>
            <div><h5 style="font-size:15px;">${r[1]}, ${r[2]} ${r[4]}</h5><p style="margin-top:2px;">PUROK ${r[17]}</p></div>
        </div>
        <i class="fas fa-chevron-right" style="color:#cbd5e1; font-size:14px;"></i>
    `;
    list.appendChild(div);
  });
}
function changeRecPage(dir) { recPage += dir; renderList(); }

function viewRecord(index) {
    const r = records[index];
    const html = HEADERS_RBIS.map((h, i) => `<div style="border-bottom:1px solid #f1f5f9; padding:12px 0;"><span style="font-size:10px; color:#94a3b8; display:block; font-weight:700; letter-spacing:0.5px;">${h}</span><span style="font-size:15px; font-weight:600; color:#334155;">${r[i] || '-'}</span></div>`).join('');
    document.getElementById('viewer-content').innerHTML = html;
    document.getElementById('viewer-actions').innerHTML = `<button class="btn btn-warning" onclick="startEdit(${index})" style="background:#f59e0b; color:white; box-shadow:0 4px 12px rgba(245, 158, 11, 0.4);">EDIT RECORD</button><button class="btn btn-ghost" onclick="closeViewer()">CLOSE</button>`;
    document.getElementById('viewer-overlay').style.display = 'flex';
}
function closeViewer() { document.getElementById('viewer-overlay').style.display = 'none'; }

function openHHModal(index = -1) {
    document.getElementById('hh-modal').style.display = 'flex';
    document.getElementById('hh-pred-list').style.display = 'none';
    document.getElementById('hh-member-search').value = '';
    
    if(index > -1) { 
        currentEditingHH = households[index];
        tempHHMembers = currentEditingHH.members.map(m => {
            if(typeof m === 'object') return m; 
            return { index: m, role: "MEMBER" }; 
        });
        document.getElementById('hh-id-input').value = currentEditingHH.id;
    } else { 
        currentEditingHH = null; tempHHMembers = []; document.getElementById('hh-id-input').value = "";
    }
    renderHHMembersPreview();
}
function closeHHModal() { document.getElementById('hh-modal').style.display = 'none'; }

function searchMemberForHH() {
    const val = document.getElementById('hh-member-search').value.toLowerCase();
    const list = document.getElementById('hh-pred-list'); list.innerHTML = '';
    if(val.length < 2) { list.style.display = 'none'; return; }

    const occupiedIndices = new Set();
    households.forEach(hh => {
        if(currentEditingHH && hh === currentEditingHH) return;
        hh.members.forEach(m => {
             let idx = (typeof m === 'object') ? m.index : m;
             occupiedIndices.add(idx);
        });
    });

    const matches = records.map((r, i) => ({name: `${r[1]}, ${r[2]}`, index: i}))
                         .filter(m => m.name.toLowerCase().includes(val));
    const finalMatches = matches.filter(m => !occupiedIndices.has(m.index));

    if(finalMatches.length > 0) {
        list.style.display = 'block';
        finalMatches.slice(0, 5).forEach(m => {
            const li = document.createElement('li'); li.className = 'pred-item'; li.innerText = m.name;
            li.onclick = () => addMemberToHH(m.index); list.appendChild(li);
        });
    } else list.style.display = 'none';
}

function addMemberToHH(recordIndex) {
    if(!tempHHMembers.some(m => m.index === recordIndex)) {
        tempHHMembers.push({ index: recordIndex, role: "MEMBER" }); 
        renderHHMembersPreview();
        document.getElementById('hh-member-search').value = ''; document.getElementById('hh-pred-list').style.display = 'none';
    } else showToast("Person already in this list.", "error");
}

function updateMemberRole(tempIndex, newRole) {
    tempHHMembers[tempIndex].role = newRole;
}

function removeMemberFromHH(tempIndex) {
    tempHHMembers.splice(tempIndex, 1); renderHHMembersPreview();
}

function renderHHMembersPreview() {
    const div = document.getElementById('hh-members-display'); div.innerHTML = '';
    if(tempHHMembers.length === 0) { div.innerHTML = '<small style="color:#94a3b8; font-style:italic;">No members added yet.</small>'; return; }
    
    tempHHMembers.forEach((mObj, i) => {
        const r = records[mObj.index];
        if(r) {
            const roles = ["MEMBER", "HEAD OF HOUSEHOLD", "SPOUSE", "SON", "DAUGHTER", "OTHERS"];
            let roleOptions = roles.map(role => `<option value="${role}" ${mObj.role===role?'selected':''}>${role}</option>`).join('');
            
            div.innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #f1f5f9; padding-bottom:8px;">
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:13px; color:#334155;">${r[1]}, ${r[2]}</div>
                    <select onchange="updateMemberRole(${i}, this.value)" style="padding:6px; font-size:11px; margin-top:4px; width:95%; border:1px solid #cbd5e1; border-radius:6px;">${roleOptions}</select>
                </div>
                <i class="fas fa-times" style="color:#ef4444; cursor:pointer; padding:8px; background:#fee2e2; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-size:12px;" onclick="removeMemberFromHH(${i})"></i>
            </div>`;
        }
    });
}

function saveHousehold() {
    const hhID = document.getElementById('hh-id-input').value.trim();
    if(!hhID) { showToast("Household Number required", "error"); return; }
    if(tempHHMembers.length === 0) { showToast("Add at least one member", "error"); return; }

    if(currentEditingHH) { currentEditingHH.id = hhID; currentEditingHH.members = tempHHMembers; showToast("Household Updated", "success"); } 
    else { households.push({ id: hhID, members: tempHHMembers }); showToast("Household Created", "success"); }
    
    localStorage.setItem('rbiHouseholds', JSON.stringify(households)); closeHHModal(); renderHouseholdList();
}

function renderHouseholdList() {
    const container = document.getElementById('hh-list-container');
    const search = document.getElementById('searchHH').value.toLowerCase();
    container.innerHTML = '';
    
    let filtered = households.filter(hh => {
        if(hh.id.toLowerCase().includes(search)) return true;
        return hh.members.some(m => {
            let idx = (typeof m === 'object') ? m.index : m;
            const r = records[idx];
            return r && (r[1].toLowerCase().includes(search) || r[2].toLowerCase().includes(search));
        });
    });

    const itemsPerPage = 5; const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
    if(hhPage > totalPages) hhPage = totalPages; if(hhPage < 1) hhPage = 1;
    
    document.getElementById('hh-page-indicator').innerText = `Page ${hhPage} of ${totalPages}`;
    document.getElementById('btn-prev-hh').className = `page-btn ${hhPage===1?'disabled':''}`;
    document.getElementById('btn-next-hh').className = `page-btn ${hhPage===totalPages?'disabled':''}`;

    const pageItems = filtered.slice((hhPage - 1) * itemsPerPage, (hhPage - 1) * itemsPerPage + itemsPerPage);
    if(pageItems.length === 0) { container.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8; font-style:italic;">No Households Found</div>'; return; }

    pageItems.forEach(hh => {
        const realIndex = households.indexOf(hh);
        let heads = hh.members.filter(m => (typeof m === 'object' && m.role === 'HEAD OF HOUSEHOLD'));
        if(heads.length === 0 && hh.members.length > 0) heads = [hh.members[0]]; 
        
        let headNames = heads.map(h => {
             let idx = (typeof h === 'object') ? h.index : h;
             return records[idx] ? `${records[idx][1]}, ${records[idx][2]}` : "Unknown";
        }).join(" & ");

        const div = document.createElement('div'); div.className = 'record-card';
        div.onclick = () => openHHModal(realIndex);
        div.innerHTML = `<div><h5 style="color:var(--accent); font-weight:800;">HH: ${hh.id}</h5><p><b>Head:</b> ${headNames}</p><p style="font-size:11px; margin-top:2px;">Members: ${hh.members.length}</p></div><i class="fas fa-pencil-alt" style="color:#94a3b8;"></i>`;
        container.appendChild(div);
    });
}
function changeHHPage(dir) { hhPage += dir; renderHouseholdList(); }

function updateMotherDatalist() {
    const dl = document.getElementById('motherList'); dl.innerHTML = ''; const uniqueMothers = new Set();
    records.forEach(r => { if(r[16] && r[14]) { const k = `${r[16]}, ${r[14]}`; if(!uniqueMothers.has(k)){ uniqueMothers.add(k); const o = document.createElement('option'); o.value = `${r[16]}, ${r[14]} ${r[15] || ''}`.trim(); dl.appendChild(o); }}});
}
function autoFillMother(inputObj) {
    const val = inputObj.value; const found = records.find(r => `${r[16]}, ${r[14]} ${r[15] || ''}`.trim() === val);
    if(found) { document.getElementById('mLast').value = found[16]; document.getElementById('mFirst').value = found[14]; document.getElementById('mMiddle').value = found[15]; }
}

// --- NEW EXPORT LOGIC ---
function openExportModal() {
    if(records.length === 0){ showToast("No records to export.", "error"); return; }
    document.getElementById('export-options-modal').style.display = 'flex';
}

function closeExportModal() {
    document.getElementById('export-options-modal').style.display = 'none';
}

function processExport(type) {
    closeExportModal();
    if(type === 'BOTH') {
        exportData('RBIS');
        setTimeout(() => exportData('BIMS'), 1500); // Delay for second download
    } else {
        exportData(type);
    }
}

function getBIMSInstructions() {
    return [
        ["COLUMNS", "EXPECTED VALUES/ FORMAT", "REMARKS"],
        ["INHABITANT TYPE", "NON-MIGRANT", "Required Field"],
        ["", "MIGRANT", ""],
        ["", "TRANSIENT", ""],
        ["LAST NAME", "", "Required Field"],
        ["FIRST NAME", "", "Required Field"],
        ["MIDDLE NAME", "", "Optional Field"],
        ["SUFFIX", "", "Optional Field"],
        ["BIRTH PLACE", "", "Optional Field"],
        ["BIRTHDATE (YYYY-MM-DD)", "2000-12-30", "Required Field"],
        ["SEX", "MALE", "Required Field"],
        ["", "FEMALE", "Required Field"],
        ["CIVIL STATUS", "SINGLE", "Required Field"],
        ["", "MARRIED", "Required Field"],
        ["", "WIDOWED", "Required Field"],
        ["", "SEPARATED", "Required Field"],
        ["", "COMMON LAW/ LIVE-IN", "Required Field"],
        ["CITIZENSHIP", "FILIPINO", "Required Field"],
        ["", "FOREIGNER", "Required Field"],
        ["PROFESSION/ OCCUPATION", "", "Optional Field"],
        ["CONTACT NUMBER", "", "Optional Field"],
        ["EMAIL ADDRESS", "", "Optional Field"],
        ["HIGHEST EDUCATIONAL ATTAINMENT", "", "Optional Field"],
        ["MOTHER'S FIRST NAME", "", "Optional Field"],
        ["MOTHER'S MIDDLE NAME", "", "Optional Field"],
        ["MOTHER'S LAST NAME", "", "Optional Field"]
    ];
}

function exportData(format) {
    showLoading(true, `GENERATING ${format}`, "Preparing Download...");
    
    setTimeout(() => {
        try {
            const wb = XLSX.utils.book_new();
            let filename = `RBI_${format}_${new Date().toISOString().slice(0,10)}.xlsx`;

            if(format === 'RBIS') {
                const instructionData = [["INSTRUCTIONS"], ["Generated by RBI FIELD"], ["Full Data Export"]];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(instructionData), "INSTRUCTIONS");
                const allData = [HEADERS_RBIS, ...records];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(allData), "DATA");
            } 
            else if (format === 'BIMS') {
                // 1. Static Instructions Sheet
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(getBIMSInstructions()), "INSTRUCTIONS");
                
                // 2. Filtered Data Sheet (First 17 columns only)
                const bimsRecords = records.map(r => r.slice(0, 17)); // Drop cols 17+ (Purok, etc)
                const allData = [HEADERS_BIMS, ...bimsRecords];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(allData), "DATA");
            }

            const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
            const blob = new Blob([wbout], {type:"application/octet-stream"});
            const file = new File([blob], filename, {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

            // Force Download
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);

            // Save for sharing (only saves the last file generated if downloading both)
            currentExportFile = file;

            showLoading(false);
            
            // Only show share prompt if single file (to avoid spamming modals on "Both")
            setTimeout(() => {
                document.getElementById('share-modal').style.display = 'flex';
            }, 500);

        } catch (e) {
            showLoading(false);
            showToast("Export Error: " + e.message, "error");
        }
    }, 200);
}

async function triggerShareAction() {
    if(!currentExportFile) {
        showToast("No file to share.", "error");
        return;
    }
    
    // Explicit Share Data Construction
    const shareData = {
        files: [currentExportFile],
        title: 'RBI Export',
        text: 'Here is the exported RBI Field Data.'
    };

    // Robust Share Logic
    try {
        // Try sharing directly (skipping canShare check which is flaky on some Androids)
        await navigator.share(shareData);
        closeShareModal();
        showToast("Shared successfully!", "success");
    } catch (err) {
        // If that fails, try the check (fallback logic)
        if (navigator.canShare && navigator.canShare(shareData)) {
             try {
                await navigator.share(shareData);
             } catch (retryErr) {
                console.log(retryErr);
             }
        }
        
        console.error("Share failed:", err);
        if (err.name !== 'AbortError') {
            showToast("Share failed. Please share manually from Downloads.", "info");
        }
        closeShareModal();
    }
}

function closeShareModal() {
    document.getElementById('share-modal').style.display = 'none';
}
</script>
</body>
</html>
